{% extends "backoffice_base.html" %}

{% load static %}
{% block scripts %}
<script type="module" src="{% static "get-telemetry.js" %}" defer></script>
{% endblock %}

{% block heading %}Vehicle: {{ vehicle.registration }}{% endblock %}
{% block buttons %}

{% endblock %}

{% block main %}

<a href="{% url "get_telemetry" %}" class="hidden" id="telemetry_url"></a>
<input type="hidden" id="vehicle_id" value="{{ vehicle.id }}">
{% csrf_token %}

<div class="m-8 flex flex-row flex-wrap gap-2">  
    {% if vehicle.picture %}
        <img class="h-32 w-32 rounded-md"
                src="{{ vehicle.picture.url }}"
                alt="">
    {% else %}
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                stroke="currentColor" class="w-24 h-24 rounded-md text-gray-300">
            <path stroke-linecap="round" stroke-linejoin="round"
                d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"/>
        </svg>
    {% endif %}
    {% if most_recent.soc.value %}
        <div class="relative w-32 h-32">
        <svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
            <circle class="text-gray-200 stroke-current" cx="50" cy="50" r="40" stroke-width="10" fill="transparent" />
            {% if most_recent.soc.value > 75 %}
                    <circle class="text-green-500 stroke-current" cx="50" cy="50" r="40" stroke-width="10" fill="transparent"
            stroke-dasharray="251.2" stroke-dashoffset="{{ most_recent.soc_dial }}" stroke-linecap="round" />
            {% elif most_recent.soc.value > 50 %}
                    <circle class="text-amber-500 stroke-current" cx="50" cy="50" r="40" stroke-width="10" fill="transparent"
            stroke-dasharray="251.2" stroke-dashoffset="{{ most_recent.soc_dial }}" stroke-linecap="round" />
            {% else %}
                    <circle class="text-red-500 stroke-current" cx="50" cy="50" r="40" stroke-width="10" fill="transparent"
            stroke-dasharray="251.2" stroke-dashoffset="{{ most_recent.soc_dial }}" stroke-linecap="round" />
            {% endif %}
        </svg>
        <div class="absolute inset-0 flex items-center justify-center text-xl font-bold text-gray-800">
        {{ most_recent.soc.value }}%
        </div>
    </div>
  {% endif %}
  <div>{{ most_recent.soc.age|default:"State of charge telemetry not received" }}<br>({{ most_recent.soc.created_at|default:"na" }})</div>
<div class="">
    <div class="sm:flex sm:items-center">
      <div class="sm:flex-auto">
        <h1 class="text-xl font-semibold text-gray-900">Most Recent Telemetry Data for {{ vehicle.registration }}</h1>
      </div>
    </div>
    <div class="mt-8 flex flex-col">
        <div class="-my-2 -mx-4 overflow-x-auto sm:-mx-6 lg:-mx-8">
            <div class="inline-block min-w-fit py-2 align-middle md:px-6 lg:px-8">
                <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
                    <table>
                        <thead>
                            <tr class="border-b border-t border-gray-200 bg-gray-50 px-6 py-3 text-left text-sm font-semibold text-gray-900">
                                <th class="border-b border-gray-200 px-6 py-3 text-left text-sm font-semibold text-gray-900 w-6">Telemetry</th>
                                <th class="border-b border-gray-200 px-6 py-3 text-left text-sm font-semibold text-gray-900 w-5">Value</th>
                                <th class="border-b border-gray-200 px-6 py-3 text-left text-sm font-semibold text-gray-900 w-8">Age</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100 bg-white">
                            <tr>
                                <td class="whitespace-nowrap px-6 py-3 text-left text-sm text-gray-500">Doors Locked</td>
                                <td class="whitespace-nowrap px-6 py-3 text-left text-sm text-gray-500">{{ most_recent.doors_locked.value }}</td>
                                <td class="whitespace-nowrap px-6 py-3 text-left text-sm text-gray-500">{{most_recent.doors_locked.age}}</td>
                            </tr>
                            <tr>
                                <td class="whitespace-nowrap px-6 py-3 text-left text-sm text-gray-500">Aux Battery</td>
                                <td class="whitespace-nowrap px-6 py-3 text-left text-sm text-gray-500">{{ most_recent.battery.value }}v</td>
                                <td class="whitespace-nowrap px-6 py-3 text-left text-sm text-gray-500">{{most_recent.battery.age}}</td>
                            </tr>
                            <tr>
                                <td class="whitespace-nowrap px-6 py-3 text-left text-sm text-gray-500">State of Charge</td>
                                <td class="whitespace-nowrap px-6 py-3 text-left text-sm text-gray-500">{{ most_recent.soc.value }}%</td>
                                <td class="whitespace-nowrap px-6 py-3 text-left text-sm text-gray-500">{{most_recent.soc.age}}</td>
                            </tr>
                            <tr>
                                <td class="whitespace-nowrap px-6 py-3 text-left text-sm text-gray-500">Free Heap</td>
                                <td class="whitespace-nowrap px-6 py-3 text-left text-sm text-gray-500">{{ most_recent.free_heap.value }}</td>
                                <td class="whitespace-nowrap px-6 py-3 text-left text-sm text-gray-500">{{most_recent.free_heap.age}}</td>
                            </tr>
                            <tr>
                                <td class="whitespace-nowrap px-6 py-3 text-left text-sm text-gray-500">Box Uptime</td>
                                <td class="whitespace-nowrap px-6 py-3 text-left text-sm text-gray-500">{{ most_recent.uptime.value }}</td>
                                <td class="whitespace-nowrap px-6 py-3 text-left text-sm text-gray-500">{{most_recent.uptime.age}}</td>
                            </tr>
                            <tr>
                                <td class="whitespace-nowrap px-6 py-3 text-left text-sm text-gray-500">Odometer</td>
                                <td class="whitespace-nowrap px-6 py-3 text-left text-sm text-gray-500">{{ most_recent.miles.value }}</td>
                                <td class="whitespace-nowrap px-6 py-3 text-left text-sm text-gray-500">{{most_recent.miles.age}}</td>
                            </tr>
                    </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    </div>
</div>

<div class="p-4 sm:p-6 lg:p-8">
    <div class="sm:flex sm:items-center">
      <div class="sm:flex-auto">
        <h1 class="text-xl font-semibold text-gray-900">Previous, Current and Next Bookings for {{ vehicle.registration }}</h1>
      </div>
    </div>
    <div class="mt-8 flex flex-col">
        <div class="-my-2 -mx-4 overflow-x-auto sm:-mx-6 lg:-mx-8">
            <div class="inline-block min-w-full py-2 align-middle md:px-6 lg:px-8">
                <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
                    {% include "backoffice/bookings/bookings_list.html" with bookings=bookings %}
                </div>
            </div>
        </div>
    </div>

    <div class="sm:flex sm:items-center mt-8">
      <div class="sm:flex-auto">
        <h1 class="text-xl font-semibold text-gray-900">All Telemetry Data From Last 7 Days for {{ vehicle.registration }}</h1>
      </div>
    </div>
    <div class="mt-8 flex flex-col">
        <div class="-my-2 -mx-4 overflow-x-auto sm:-mx-6 lg:-mx-8">
            <div class="inline-block min-w-full py-2 align-middle md:px-6 lg:px-8">
                <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
                    {% include "backoffice/vehicles/telemetry-list.html" with telemetry=page %}

                    {% include "backoffice/components/paginator.html" with page=page page_range=page_range %}
                </div>
            </div>
        </div>
    </div>
</div>
    
<h3 class="text-xl font-semibold text-gray-900 mt-8 ml-8">State of Charge for Last 7 Days</h3>
    <div class="my-2 mx-8">
        <div class="flex flex-row bg-blue-100 border-t border-b border-blue-500 text-blue-700 px-4 py-3" role="alert">
            <svg class="fill-current w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M12.432 0c1.34 0 2.01.912 2.01 1.957 0 1.305-1.164 2.512-2.679 2.512-1.269 0-2.009-.75-1.974-1.99C9.789 1.436 10.67 0 12.432 0zM8.309 20c-1.058 0-1.833-.652-1.093-3.524l1.214-5.092c.211-.814.246-1.141 0-1.141-.317 0-1.689.562-2.502 1.117l-.528-.88c2.572-2.186 5.531-3.467 6.801-3.467 1.057 0 1.233 1.273.705 3.23l-1.391 5.352c-.246.945-.141 1.271.106 1.271.317 0 1.357-.392 2.379-1.207l.6.814C12.098 19.02 9.365 20 8.309 20z"/></svg>
            <p id="graph_message"></p>
        </div>
    </div>
    <svg id="graph" width="1000"></svg>

{% endblock %}
